# Sage script for lattice attack
# Generated from Python preparation

modulo = 927943022418138721022360056414021691267449268561
trick = 1812388715660427103868260568787565913302892544
nn = 20

AA = [-1, 277783933949656438718423027901495635725403621533, 894079209621918382896444979919421990724683959827, 773269357572651091992290242866879615569189109883, 152407352376871887122856325226964593496633716228, 41176324957025051597191450440715461939347676454, 425927073462482159743877463467738877090168473361, 864955584657518696553481463062061888762066160870, 594594160605145604775607035634898503748718462579, 368678314364039824174987201859107877615320023470, 443380087862708692534659335350855845062722461395, 566264934454509762662932296538497302690024211420, 823218672611698060767062571776697770064235325580, 248674869462688485079931731975826008122656251250, 122637752256568971415596846431273991481942018998, 616666128489029847430196400197774605616212174469, 54044550198199312084822724963984667376969719765, 103422304639462792739688630564470222870878573517, 139290384840617279460879479452209989308499986076, 63685490500432362272038784685816539020064674309]
BB = [0, 57663172811146863049092243891307528245821436032, 102279934888486170292441793668786484206881181316, 271004350566980917812682860164649995428692909862, 495766517322880855298257105909436769959435185881, 695434582999116062974351399094636771621538054240, 334171103448705042894339177009027232322885382465, 557539383016177937144430573975245444599307422632, 107973678013759434150429877704900529065541886484, 366259143477391566607711113852103537876924746615, 261555230154878635182637212150228625412219605093, 427451235527587542414452551176518379691674028707, 714786306787891015374254304815541201275162955646, 792065329476399772345748585415941178439265668586, 40856219962130793098492091035953430154317972789, 222760503242835272004594119371670158909458414562, 768973915924972586430904780607516879904558122954, 698519921072445630276710886217079621942159597856, 370618841864549421237692442366179290517277811130, 815934368320717127623205755193191392065489990312]

first_r = 29178288144072822714405951139088911410894175107
first_s = 39460513883381333836474199963783122914858080344
first_m = 37592873801746904410398690060748424303362045737704985040182603741872729091191


# Embedding Technique (CVP->SVP)
if trick != -1:
    lattice = Matrix(ZZ, nn + 1)
else:
    lattice = Matrix(ZZ, nn)

# Fill lattice
for ii in range(nn):
    lattice[ii, ii] = modulo
    lattice[0, ii] = AA[ii]

# Add trick
if trick != -1:
    print(f"Adding trick: {trick}")
    BB.append(trick)
    lattice[nn] = vector(BB)
else:
    print("Not adding any trick")

print("Using LLL reduction")
lattice = lattice.LLL()

# Check if solution is found
if trick == -1 or Mod(lattice[0,-1], modulo) == trick or Mod(lattice[0,-1], modulo) == Mod(-trick, modulo):
    print("Solution found in lattice!")
    
    # did we found trick or -trick?
    if trick != -1:
        # trick
        if Mod(lattice[0,-1], modulo) == trick:
            solution = -1 * lattice[0] - vector(BB)
        # -trick
        else:
            print("We found a -trick instead of a trick")
            solution = lattice[0] + vector(BB)
    else:
        solution = -1 * lattice[0] - vector(BB)

    # get rid of (..., trick) if we used the trick
    if trick != -1:
        vec = list(solution)
        vec.pop()
        solution = vector(vec)

    # recover private key
    nonce = solution[0]
    key = Mod((first_s * nonce - first_m) * inverse_mod(first_r, modulo), modulo)
    
    print(f"Recovered private key candidate: {key}")
    print(f"KEY_RESULT = {key}")
else:
    print("No solution found in lattice")
    print("KEY_RESULT = 0")
