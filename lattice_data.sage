# Sage script for lattice attack
# Generated from Python preparation

modulo = 1244253629364168420089641995863757833005794977483
trick = 9492901835358951428383951247860185759219712
nn = 20

AA = [-1, 525771644673554059254611892318602123974594217677, 832668514159701865654466548258755602861331749584, 509294459215500985628046688279775280210129264833, 170736131341407474783119344714306678501188726491, 947013843975022178901674950195720213551545117979, 212381547376363465621785062411157474017381806320, 223048849080743018885481719148609764087147155855, 655017309612076686724494140923180252217365034552, 461078510865107999486363461170401813105511034131, 477274120364374827142309951652676831750615264544, 776555220771047685267882714082202541613279620939, 46968676500127407767866620327863638954209565140, 959920073057892131883969266802115935429033305362, 48527974058026447991038332704628829778755100300, 355954628764764819526493322690417882342665173025, 556486176822569442562608729722862186569698987084, 425976941713072577872059074895871256328265908516, 291223085516646890453435250970505554606885503074, 786492327721531870411261951154203121979233255978]
BB = [0, 771405308182216213965363302621276780998872014934, 1056111265104802742096000982993643754372217119078, 1002741872778755658766865024331956534316886388316, 538289737645624927814897256349099954338706358485, 228380165663146365878825687528334906566212003639, 669936920612755207225254092489903989464909558588, 16938434343813482714970379000613967523931662170, 1105865585814215712213598017046991649301680400922, 464114410340587428601009859809357733805340919343, 925888942878261937864428253466506446480251689706, 341122381398246855725301605386936791119453124675, 60294283455500275365401394683993036801862523434, 587694294571528055518296046133235899444001924202, 342045961975889577939734142614459972441345412603, 59882335718242837164988956997258059223727958576, 563053251646526277118073497048426497117910833732, 150481358353685467337616083597531682820726162460, 695773638459036700706169393145625190629117023881, 199235460685606812474587254637220593897806655009]

first_r = 707786373065967986377356394207154808726037108152
first_s = 1208710668465162720687169396969626445504725483415
first_m = 59278515725462727369350407508105788780873551902060752560339638142653032882781


# Embedding Technique (CVP->SVP)
if trick != -1:
    lattice = Matrix(ZZ, nn + 1)
else:
    lattice = Matrix(ZZ, nn)

# Fill lattice
for ii in range(nn):
    lattice[ii, ii] = modulo
    lattice[0, ii] = AA[ii]

# Add trick
if trick != -1:
    print(f"Adding trick: {trick}")
    BB.append(trick)
    lattice[nn] = vector(BB)
else:
    print("Not adding any trick")

print("Using LLL reduction")
lattice = lattice.LLL()

# Check if solution is found
if trick == -1 or Mod(lattice[0,-1], modulo) == trick or Mod(lattice[0,-1], modulo) == Mod(-trick, modulo):
    print("Solution found in lattice!")
    
    # did we found trick or -trick?
    if trick != -1:
        # trick
        if Mod(lattice[0,-1], modulo) == trick:
            solution = -1 * lattice[0] - vector(BB)
        # -trick
        else:
            print("We found a -trick instead of a trick")
            solution = lattice[0] + vector(BB)
    else:
        solution = -1 * lattice[0] - vector(BB)

    # get rid of (..., trick) if we used the trick
    if trick != -1:
        vec = list(solution)
        vec.pop()
        solution = vector(vec)

    # recover private key
    nonce = solution[0]
    key = Mod((first_s * nonce - first_m) * inverse_mod(first_r, modulo), modulo)
    
    print(f"Recovered private key candidate: {key}")
    print(f"KEY_RESULT = {key}")
else:
    print("No solution found in lattice")
    print("KEY_RESULT = 0")
